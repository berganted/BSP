<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="book">

 <sql id="bookwhere">
		<where>
				<if test="sval != null and sval !=''">
					<if test="stype == 'all'">
					b_title LIKE '%${sval}%' OR b_publisher LIKE '%${sval}%' OR b_stock LIKE '%${sval}%'
				</if>
				<if test="stype != 'all'">
					${stype} LIKE '%${sval}%'
				</if>
			</if>
		</where>
</sql>
	

	
 	<select id="selectAll" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM book
		<include refid="bookwhere"/>
		 ORDER BY ${orderby} ${direct}	
	</select>
		
	<select id="selectAlladmin" resultType="book.BookVo" parameterType="book.BookVo"><!-- 건들지마샘 -->
		SELECT * FROM book
		<include refid="bookwhere"/>
		 ORDER BY b_regdate ${direct}	
		 LIMIT ${strIdx},${pageRow} 
	</select>
	

	<!-- 베스트셀러  아직 ㄴㄴ-->
	 <select id="BEST_K" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM book WHERE b_ctgno1=1 OREDER BY b_stock DESC;
		<include refid="bookwhere"/>
		 ORDER BY ${orderby} ${direct}	
	</select>
	
	<!-- 책 상세페이지 -->
	<select id="bookDetail" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM book WHERE b_ctgno1=1 OREDER BY b_stock DESC;
		<include refid="bookwhere"/>
		 ORDER BY ${orderby} ${direct}	
	</select>
	
	
	
	<!--대중분류페이지 3개 리스트-->
	<!-- BSP의 선택 -> 기준필요!! -->
	<select id="selectAll1" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * ,
		(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain
		FROM book  JOIN categorysmall ON book.b_ctgno2key=categorysmall.b_ctgno2key 
		WHERE book.b_ctgno1=#{b_ctgno1} AND categorysmall.b_ctgno2=#{b_ctgno2}
		<include refid="bookwhere"/>
		ORDER BY ${orderby} ${direct}
		LIMIT 0,3
	</select>
	
	<!--  베스트셀러 -> 기준필요!!  -->
	<select id="selectAll2" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,
		(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain
		FROM book  JOIN categorysmall ON book.b_ctgno2key=categorysmall.b_ctgno2key 
		WHERE book.b_ctgno1=#{b_ctgno1} AND categorysmall.b_ctgno2=#{b_ctgno2}
		ORDER BY book.b_intodate DESC
		
		<include refid="bookwhere"/>
			LIMIT 0,4
	</select>
	
	<!-- 눈에 띄는 책-> 기준필요!! 입고일순.-->
	<select id="selectAll3" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * ,
		(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain
		FROM book  JOIN categorysmall ON book.b_ctgno2key=categorysmall.b_ctgno2key 
		WHERE book.b_ctgno1=#{b_ctgno1} AND categorysmall.b_ctgno2=#{b_ctgno2} <!-- AND b_no <![CDATA[>=]]> 3 and b_no <![CDATA[<=]]>8 -->
		ORDER BY book.b_intodate DESC 
		LIMIT 0,6
	</select>
	

	<!-- 상세분류 클릭- 리스트 -->	
	<select id="selectAllBasic" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *
			,(SELECT b_ctgdetail FROM categorysmall WHERE b_ctgno2key=book.b_ctgno2key) AS b_ctgdetail
			,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain
		FROM book WHERE b_ctgno2key=#{b_ctgno2key} AND b_ctgno1=#{b_ctgno1}
		<include refid="bookwhere"/>
		ORDER BY ${orderby} ${direct}			
		LIMIT ${strIdx},${pageRow} 
	</select>
		
	
	
	<!--도서 중분류 값 ex소설 selectOne-->
	<!-- <select id="selectCtgno2" parameterType="book.BookVo" resultType="book.BookVo">
		SELECT * FROM categorysmall WHERE b_ctgno2key=#{b_ctgno2key} AND b_ctgno1=#{b_ctgno1}
	</select> -->
	
	<select id="selectCtgno2" parameterType="book.BookVo" resultType="book.BookVo">
		SELECT * FROM categorysmall WHERE b_ctgno2key=#{b_ctgno2key} 
	</select>
	
	
	<!-- 도서 상세분류 값 ex판타지소설 selectAll-->
	<select id="selectctgnamed" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM categorysmall WHERE b_ctgno2=#{b_ctgno2} 
	</select>
	



	<select id="count" resultType="int" parameterType="book.BookVo">
		SELECT COUNT(*) FROM book
		<include refid="bookwhere"/>
	</select>
	
	<!-- smallindex 페이징처리 Count -->
	<select id="smallCount" resultType="int" parameterType="book.BookVo">
		SELECT COUNT(*) 
			,(SELECT b_ctgdetail FROM categorysmall WHERE b_ctgno2key=book.b_ctgno2key) AS b_ctgdetail
			,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain
		FROM book WHERE b_ctgno2key=#{b_ctgno2key} AND b_ctgno1=#{b_ctgno1}
		<include refid="bookwhere"/>
		
	</select>
 
 	<insert id="bookimg" parameterType="book.BookVo">
		INSERT INTO img (b_imgmain) VALUES(#{b_imgmain})
		<selectKey keyProperty="b_imgno" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
 
	<insert id="insert" parameterType="book.BookVo">
	INSERT INTO book (b_imgno,b_ctgno1,b_ctgno2,b_title,b_content,b_author,b_publisher,b_isbn,b_stock,b_price,b_index,b_pages,b_introauthor,b_introbook,b_point,b_regdate)
	VALUES (#{b_imgno},#{b_ctgno1},#{b_ctgno2},#{b_title},#{b_content},#{b_author},#{b_publisher},#{b_isbn},#{b_stock},#{b_price},#{b_index}
	,#{b_pages},#{b_introauthor},#{b_introbook},#{b_point},NOW())
	</insert> 
	

	<select id="detail" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain FROM book WHERE b_no = #{b_no}
	</select>
	
	
	<delete id="delete" parameterType="book.BookVo">
		DELETE FROM book WHERE b_no=#{b_no}
	</delete>
	
	<update id="update" parameterType="book.BookVo">
		UPDATE book SET
		<if test="b_imgno != 0">
			b_imgno=#{b_imgno},
			</if>
			b_ctgno1=#{b_ctgno1},b_ctgno2=#{b_ctgno2},b_title=#{b_title},b_content=#{b_content},b_author=#{b_author},b_publisher=#{b_publisher}
			,b_isbn=#{b_isbn},b_stock=#{b_stock},b_price=#{b_price},b_index=#{b_index},b_pages=#{b_pages},b_introauthor=#{b_introauthor},b_introbook=#{b_introbook}
			,b_point=#{b_point},b_intodate=#{b_intodate}
		WHERE b_no=#{b_no}
	</update>
	
</mapper>