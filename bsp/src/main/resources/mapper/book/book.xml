<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="book">

	<sql id="bookwhere">
		<where>
				<if test="sval != null and sval !=''">
					<if test="stype == 'all'">
					b_title LIKE '%${sval}%' OR b_publisher LIKE '%${sval}%' OR b_stock LIKE '%${sval}%' OR b_author LIKE '%{sval}%'
				</if>
				<if test="stype != 'all'">
					${stype} LIKE '%${sval}%'
				</if>
			</if>
		</where>
	</sql>
	

	
	<select id="selectAll" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM book WHERE b_ctgno1 = 1
		<include refid="bookwhere"/>
		<!-- ORDER BY ${orderby} ${direct} -->
		 ORDER BY ${orderby} ${direct}	
	</select>
		
	<select id="selectAlladmin" resultType="book.BookVo" parameterType="book.BookVo"><!-- 건들지마샘 -->
		SELECT * FROM book
		<include refid="bookwhere"/>
		 ORDER BY ${orderby} ${direct}	
		 LIMIT ${strIdx},${pageRow} 
	</select>
	
	<!-- 	
	<select id="selectAll" resultType="comment.CommentVo" parameterType="comment.CommentVo">
		SELECT *,(SELECT name FROM user WHERE no=comment.user_no ) AS name FROM comment  누가 썼는지 알고싶으면 있어야해 
		WHERE board_no=#{board_no} AND tablename=#{tablename}
		ORDER BY regdate DESC
		LIMIT ${startIdx},${pageRow}
	</select> -->
	
	
	<select id="selectAll1" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * ,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain FROM book
		<include refid="bookwhere"/>
		<!-- ORDER BY ${orderby} ${direct} -->
		LIMIT 0,3
	</select>
	
	
	<select id="selectAll2" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM book WHERE b_no BETWEEN 2 AND 7
		<include refid="bookwhere"/>
		<!-- ORDER BY ${orderby} ${direct} -->
			LIMIT 0,4
	</select>
	
	
	<select id="selectAll3" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM book WHERE b_no <![CDATA[>=]]> 2 and b_no <![CDATA[<=]]>7
		<include refid="bookwhere"/>
		<!-- ORDER BY ${orderby} ${direct} -->
	</select>
	
<!-- index.do 오늘의 책 -->
	<select id="selectAll4" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain
		FROM book WHERE b_no BETWEEN 1 AND 5
		<include refid="bookwhere"/>
	</select>
<!-- index.do 광고 -->	
	<select id="selectAll5" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain 
		FROM book WHERE b_no BETWEEN 9 AND 10 ORDER BY rand() LIMIT 1
		<include refid="bookwhere"/>
	</select>

		
	<select id="selectAllBasic" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,
			(SELECT b_ctgdetail FROM categorysmall WHERE b_ctgno2key=book.b_ctgno2key) AS b_ctgdetail
		FROM book
		<include refid="bookwhere"/>
		ORDER BY ${orderby} ${direct}			
		LIMIT ${strIdx},${pageRow} 
	</select>
		
	
	<select id="selectctgnamed" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT * FROM categorysmall WHERE b_ctgno2=#{b_ctgno2}
	</select>
	
	<!-- <select id="selectAll6" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT ad_img FROM ad WHERE book.b_imgno = ad.ad_img) as ad_img 
		FROM book WHERE b_no BETWEEN 10 AND 11 ORDER BY rand() LIMIT 1
		<include refid="bookwhere"/>
	</select> 도윤 test -->
	
	<select id="selectAll6" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain 
		FROM book WHERE b_no BETWEEN 10 AND 11 ORDER BY rand() LIMIT 1
		<include refid="bookwhere"/>
	</select>
	
	
	<select id="selectCtgno2" parameterType="book.BookVo" resultType="book.BookVo">
		SELECT * FROM categorysmall WHERE b_ctgno2key=#{b_ctgno2key}
	</select>
	
	

<!-- 등록된 책 총 갯수 -->
	<select id="count" resultType="int" parameterType="book.BookVo">
		SELECT COUNT(*) FROM book
		<include refid="bookwhere"/>
	</select>
<!-- 등록된 광고 총 갯수 -->
	<select id="countad" resultType="int" parameterType="book.BookVo">
		SELECT COUNT(*) FROM ad
		<include refid="bookwhere"/>
	</select>
	
	<!-- 
	 필요한가?	관리자 페이지?  b_imgno , b_ctgno1 , b_ctgno2 는 어떻게? (b_ctgno3)  
	//카테고리코드 총3개가 필요하지 않을까 대분류(국내or외국), 소분류(시, 에세이, ~), 상세분류(에세이 중 감성에세이/명상치유에세이...)
	
	 -->
 
<!-- 책 삭제 -->
	<delete id="delete" parameterType="book.BookVo">
		DELETE FROM book WHERE b_no=#{b_no}
	</delete>
 <!-- 이미지 등록 -->
 	<insert id="bookimg" parameterType="book.BookVo">
		INSERT INTO img (b_imgmain) VALUES(#{b_imgmain})
		<selectKey keyProperty="b_imgno" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
 <!-- 책 등록 -->
	<insert id="insert" parameterType="book.BookVo">
	INSERT INTO book (b_imgno,b_ctgno1,b_ctgno2,b_title,b_content,b_author,b_publisher,b_isbn,b_stock,b_price,b_index,b_pages,b_introauthor,b_introbook,b_point,b_regdate)
	VALUES (#{b_imgno},#{b_ctgno1},#{b_ctgno2},#{b_title},#{b_content},#{b_author},#{b_publisher},#{b_isbn},#{b_stock},#{b_price},#{b_index}
	,#{b_pages},#{b_introauthor},#{b_introbook},#{b_point},NOW())
	</insert> 
	
<!-- 책 상세 -->
	<select id="detail" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT b_imgmain FROM img WHERE book.b_imgno = img.b_imgno) as b_imgmain FROM book WHERE b_no = #{b_no}
	</select>
	
<!-- 광고 삭제 -->
	<delete id="deletead" parameterType="book.BookVo">
		DELETE FROM ad WHERE ad_no=#{ad_no}
	</delete>
<!-- 책 수정 -->
	<update id="update" parameterType="book.BookVo">
		UPDATE book 
		<trim prefix="SET" prefixOverrides=",">
		<if test="b_imgno != 0">
			b_imgno=#{b_imgno},
			</if>
			<if test="b_ctgno1 !=0">
			b_ctgno1=#{b_ctgno1},b_ctgno2=#{b_ctgno2},b_title=#{b_title},b_content=#{b_content},b_author=#{b_author},b_publisher=#{b_publisher}
			,b_isbn=#{b_isbn},b_stock=#{b_stock},b_price=#{b_price},b_index=#{b_index},b_pages=#{b_pages},b_introauthor=#{b_introauthor},b_introbook=#{b_introbook}
			,b_point=#{b_point},b_intodate=#{b_intodate}
			</if>
			<if test="ad_no !=0">
			,ad_no=#{ad_no}
			</if>
			</trim>
		WHERE b_no=#{b_no}
	</update>
<!-- 소분류 카테고리 -->
 	<select id="selectctg" parameterType="book.BookVo" resultType="book.BookVo">
 		SELECT * FROM categorysmall WHERE b_ctgno2key=#{b_ctgno2key}
	</select>
<!-- 광고 상세 -->
	<select id="adselect" parameterType="book.BookVo" resultType="book.BookVo">
		SELECT * FROM ad left join book on ad.b_no=book.b_no 
	</select>
<!-- 광고 이미지 등록 -->
	<insert id="bookimgad" parameterType="book.BookVo">
		INSERT INTO ad (ad_img,b_no) VALUES(#{ad_img},#{b_no})
		<selectKey keyProperty="ad_no" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
<!-- 광고수정 -->
	<update id="adupdate" parameterType="book.BookVo">
		UPDATE ad SET  <if test="ad_img != null">ad_img=#{ad_img},</if> b_no=#{b_no} WHERE ad_no=#{ad_no}
	</update>
<!-- 광고 상세 -->
	<select id="detailAD" resultType="book.BookVo" parameterType="book.BookVo">
		SELECT *,(SELECT b_no FROM book WHERE ad_no=ad.ad_no)as b_no,(SELECT b_title FROM book WHERE ad_no=ad.ad_no)as b_title FROM AD WHERE ad_no=#{ad_no}
	</select>

</mapper>