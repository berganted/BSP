<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="order">
	<sql id="orderWhere">
		<where>
			<if test="sval != null and sval != ''">
				<if test="stype == 'all'">
					ps_title LIKE '%${sval}%' OR b_title LIKE '%${sval}%'
				</if>
				<if test="stype != 'all'">
					${stype} LIKE '%${sval}%'
				</if>
			</if>
		<!-- 	<if test="m_no != 0">
				AND m_no=#{m_no}
			</if> -->
		</where>
	</sql>
	
	
		<!-- 전체주문내역 (주문번호 기준)-->
		<select id="selectAll" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT * ,  PI.pb_no FROM  product_buy AS PB JOIN  product_io AS PI 
		ON PB.pb_no = PI.pb_no
		JOIN book 
		ON PI.b_no = book.b_no
		JOIN processing_status PS
		ON PI.ps_no = PS.ps_no
		<include refid="orderWhere"/>
		GROUP BY PI.pb_no
		ORDER BY ${orderby} ${direct}
		LIMIT ${strIdx},${pageRow}
 		</select>
 		
 		<!-- 팝업창에서 출력할 코드  -->
		<select id="selectPopup" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT *, PI.pb_no FROM  product_buy AS PB JOIN  product_io AS PI 
		ON PB.pb_no = PI.pb_no
		JOIN book 
		ON PI.b_no = book.b_no
		</select>
		
		<!-- 페이징처리 -->
		<select id="count" resultType="int" parameterType="order.OrderVo">
		SELECT COUNT(*) , PI.pb_no FROM  product_buy AS PB JOIN  product_io AS PI 
		ON PB.pb_no = PI.pb_no
		JOIN book 
		ON PI.b_no = book.b_no
		JOIN processing_status PS
		ON PI.ps_no = PS.ps_no
		<include refid="orderWhere"/>
		</select>
		
		<!-- 주문상세 공통 -->
		<select id="detail1" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT * ,  PI.pb_no FROM  product_buy AS PB JOIN  product_io AS PI 
		ON PB.pb_no = PI.pb_no
		JOIN book 
		ON PI.b_no = book.b_no
		JOIN processing_status PS
		ON PI.ps_no = PS.ps_no AND PI.pb_no = #{pb_no}
		GROUP BY PI.pb_no
		</select>
		
		<!-- 주문상세 개별(도서종류) -->
		<select id="detail2" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT * ,  PI.pb_no FROM  product_buy AS PB JOIN  product_io AS PI 
		ON PB.pb_no = PI.pb_no
		JOIN book 
		ON PI.b_no = book.b_no
		JOIN processing_status PS
		ON PI.ps_no = PS.ps_no AND PI.pb_no = #{pb_no}
		</select>
		
		<!-- ADMIN 에서 쓸 코드 -->
		<!-- 관리자 주문번호 리스트 -->
		<select id="selectAdmin" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT *,
		(SELECT SUM(io_amount) from product_io WHERE pb_no=product_buy.pb_no) as amount_sum,
		(SELECT count(*) from product_io where pb_no=product_buy.pb_no)as count  
		from product_buy 
		join product_io 
		on product_buy.pb_no = product_io.pb_no
		join book
		on product_io.b_no = book.b_no
		JOIN processing_status PS
		on product_io.ps_no=ps.ps_no
		JOIN user u
		on product_buy.m_no=u.m_no
		GROUP BY product_buy.pb_no
		<include refid="orderWhere"/>
		ORDER BY ${orderby} ${direct}
		LIMIT ${strIdx},${pageRow}
 		</select>
 		<!-- 관리자 입출고번호 리스트 -->
 		<select id="selectAdmindelist" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT *
		from product_buy 
		join product_io 
		on product_buy.pb_no = product_io.pb_no
		join book
		on product_io.b_no = book.b_no
		JOIN processing_status PS
		on product_io.ps_no=ps.ps_no
		JOIN user u
		on product_buy.m_no=u.m_no
        WHERE product_buy.pb_no=#{pb_no}
		<include refid="orderWhere"/>
		ORDER BY ${orderby} ${direct}
		LIMIT ${strIdx},${pageRow}
 		</select>
 		<!-- 관리자 주문 상세 -->
 		<select id="selectoneAdmin" resultType="order.OrderVo" parameterType="order.OrderVo">
		SELECT *,
		(SELECT SUM(io_amount) from product_io WHERE pb_no=product_buy.pb_no) as amount_sum,
		(SELECT count(*) from product_io where pb_no=product_buy.pb_no)as count  
		from product_buy 
		join product_io 
		on product_buy.pb_no = product_io.pb_no
		join book
		on product_io.b_no = book.b_no
		JOIN processing_status PS
		on product_io.ps_no=ps.ps_no
		JOIN user u
		on product_buy.m_no=u.m_no
		WHERE product_buy.pb_no=#{pb_no}
		GROUP BY product_buy.pb_no
 		</select>
 		<select id="countAdmin" resultType="int" parameterType="order.OrderVo">
		SELECT count(*) FROM product_buy 
		
		<include refid="orderWhere"/>
		</select>

	</mapper>